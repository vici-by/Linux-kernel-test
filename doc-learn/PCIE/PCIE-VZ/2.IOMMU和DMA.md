# IOMMU和DMA



## X86地址结构





## 总线地址和存储域地址

<font color=red>什么是存储域地址，什么是总线域地址?</font>

* <font color=red>物理地址是指站在CPU角度，CPU经过MMU（+EPT）之后发出的地址，可以落实到真实的物理MMIO空间，用来访问内存或者设备</font>

* <font color=red>总线地址是指从从设备角度来看整个CPU端的地址，会将CPU端MMIO空间全部映射在设备端（一般是设备端提供一个基地址，访问 基地址+offset 即可访问到CPU端的地址， 这个基地址+偏移， 就是外设使用的总线地址</font>
* 使用一致性dma或者流式dma接口时，会 根据设备来将 CPU地址转换为总线地址返回。



```
               CPU                  CPU                  Bus
             Virtual              Physical             Address
             Address              Address               Space
              Space                Space

            +-------+             +------+             +------+
            |       |             |MMIO  |   Offset    |      |
            |       |  Virtual    |Space |   applied   |      |
          C +-------+ --------> B +------+ ----------> +------+ A
            |       |  mapping    |      |   by host   |      |
  +-----+   |       |             |      |   bridge    |      |   +--------+
  |     |   |       |             +------+             |      |   |        |
  | CPU |   |       |             | RAM  |             |      |   | Device |
  |     |   |       |             |      |             |      |   |        |
  +-----+   +-------+             +------+             +------+   +--------+
            |       |  Virtual    |Buffer|   Mapping   |      |
          X +-------+ --------> Y +------+ <---------- +------+ Z
            |       |  mapping    | RAM  |   by IOMMU
            |       |             |      |
            |       |             |      |
            +-------+             +------+
```





## CPU访问存储域地址过程





## IOMMU









## DMA





